# TypeDORM public API

This section contains information on all the public apis that are available within TypeDORM, this is likely to change to a live generated documentation, but until that is done, this can be used as a starting point.

_Note: In an event of inconstancy between actual API and this document, API should looked as the source of truth, and also if possible, file an issue in this repository or submit a PR._

- [TypeDORM public API](#typedorm-public-api)
  - [Connection](#connection)
  - [Table](#table)
  - [Entity](#entity)
  - [Attribute](#attribute)
  - [AutoGeneratedAttribute](#autogeneratedattribute)
  - [EntityManager](#entitymanager)
    - [EntityManager.create](#entitymanagercreate)
    - [EntityManager.findOne](#entitymanagerfindone)
    - [EntityManager.exists](#entitymanagerexists)
    - [EntityManager.update](#entitymanagerupdate)
    - [EntityManager.delete](#entitymanagerdelete)
    - [EntityManager.query](#entitymanagerquery)
  - [BatchManager](#batchmanager)
    - [BatchManager.write](#batchmanagerwrite)
    - [BatchManager.read](#batchmanagerread)
  - [TransactionManager](#transactionmanager)
    - [TransactionManager.write](#transactionmanagerwrite)
    - [TransactionManager.read](#transactionmanagerread)

## Connection

Defines connection container which will be the store all build metadatas and current operations.

```Typescript
createConnection({
  // Name of the connection, there cannot be multiple connections with same name
  // @default 'default'
  name

  // Global table to be used with table
  // @default none, if global table and entity specific table is defined, entity specific table will be used instead
  table

  // List of or path to entities
  entities

  // Max number of items to fetch when running a query
  // @default 3000
  dynamoQueryItemsImplicitLimit

  // Document client to register for current connection
  // @default new document client will be auto instantiated
  documentClient
})
```

_Note_: this does not actually create any table on cloud, it is purely for isolating all entities/operations from other connections.

## Table

Declares table to be used to store entity, can be per entity based on single table per connection.

```Typescript
Table({
  // Name of the table, must match exactly to what is provisioned on aws
  name

  // Partition key of table
  partitionKey // identifier of partition key

  // Sort key of table
  // @optional
  sortKey

  // Indexes if there are any
  indexes: {
    [indexName] : {
      partitionKey
      sortKey
      // Type of index: INDEX_TYPE
      type
    }
  }
})
```

_Note: ATM This does not actually provision any dynamodb table in aws, but it is on the road map, until that is implemented use cloudformation or similar infrastructure as code tools to provision actual dynamodb tables._

## Entity

Declare an entity to be registered in TypeDORM domain

```Typescript
@Entity({
  // Name of the entity that will be saved as __en attribute on each record
  name,

  // Table where the entity be saved
  // @optional
  // Required when no global table exits in connection
  table

  // primary key of entity, must adhere to table primary key
  primaryKey: {
    partitionKey
    // @optional
    // Required if table uses composite primary key
    sortKey
  }

  // Additional indexes to add to entity
  // @optional
  indexes: {
    // Each index specified here can only exist if it is also declared on attached table instance
    [indexName] : {
      // Partition key attribute pattern or alias schema for this entity
      // @optional
      // Required when index type is GSI
      partitionKey

      // Sort key attribute pattern or alias schema for this entity
      sortKey

      // Type of index: INDEX_TYPE
      type

      // Defines if the current index should be considered sparse
      // @default true - all indexes are marked sparse by default
      isSparse
    }
  }
})
```

## Attribute

Declare Attribute on an entity

```Typescript
@Attribute({

  // @optional
  // Can either be of type boolean or with primary key
  // When primary key is set to unique attribute, it can only reference it self
  // i.e `USER#{{email}}` on unique attribute named `email` is considered valid but not on `id`
  unique

  // @optional
  // Required when attribute type is enum and referenced in key schema
  isEnum

  // @optional
  // Define default value for current attribute
  default

  // @optional
  // Hides property from returned responses
  hidden
})
```

## AutoGeneratedAttribute

Declare Auto generated attribute on an entity

```Typescript
@AutoGenerateAttribute({

  // Strategy to use when auto generating attribute
  // Valid values are of enum `AUTO_GENERATE_ATTRIBUTE_STRATEGY`
  strategy

  // @optional
  // When true, attribute will be auto updated on write request with specified strategy
  // Useful for defining attributes like `updatedAt`
  autoUpdate

  // @optional
  // Hides property from returned responses
  hidden
})
```

## EntityManager

To Manage entity with ease.

### EntityManager.create

Create entity with given params.

```Typescript
create(
  // Entity to put into db
  // Item will be created to table configured on @Entity or Connection
  entity

  // @optional;
  // Additional options
  options: {
    // @optional
    // condition based creates
    // when present, it must evaluate to true in order for operation to succeed.
    where
  }
)
```

### EntityManager.findOne

Finds single item matching given primary key or returns undefined

```Typescript
findOne(
  // Entity class to resolve schema against
  entityClass

  // All attributes referenced in primary key
  primaryKeyAttributes

  // @optional
  // Get item options
  options: {
    // @optional
    // Specify attributes to get, only selected attributes are fetched
    // @default `ALL`
    select
  }
)
```

### EntityManager.exists

Checks existence of item

```Typescript
exists(
  // Entity class to resolve schema against
  entityClass

  // Primary key attributes or unique attributes referenced in schemas
  attributes
)
```

### EntityManager.update

Update item with magically generated set operation

```Typescript
exists(
  // Entity class to resolve schema against
  entityClass

  // Primary key attributes referenced in schemas
  primaryKeyAttributes

  // Attributes to update, if doesn't already exist,it will be created
  body

  // @optional;
  // Additional options
  options: {
    // @optional
    // Nested key separator to use, (i.e when updating user:{name},
    // body can include 'user$name' set to new value)
    // @default it '.'
    nestedKeySeparator

    // @optional
    // condition based updates
    // when present, it must evaluate to true in order for operation to succeed.
    where
  }

)
```

### EntityManager.delete

Delete item by key

```Typescript
delete(
  // Entity class to resolve schema against
  entityClass

  // Primary key attributes or unique attributes referenced in schemas
  primaryKeyAttributes

  // @optional;
  // Additional options
  options: {
    // @optional
    // condition based creates
    // when present, it must evaluate to true in order for operation to succeed.
    where
  }
)
```

### EntityManager.query

Query items from db

```Typescript
find(
  // Entity class to resolve schema against
  entityClass

  // all attributes referenced in partition key
  partitionKeyAttributes: {
    // @optional
    // Name of the index if querying against GSI/LSI
    // @default - query will be run against main table
    queryIndex
  }

  // @optional
  // Entity manager query options
  // @default none - if non specified, query will be made using only partition key
  queryOptions: {
    // @optional
    // Cursor to start querying from
    // @default - none
    cursor

    // Key condition to use when querying items
    // i.e this could be `{BEGINS_WITH: 'ORDER#'}`
    keyCondition

    // @optional
    // Total number of items to return
    // @default max limit configured in connection
    limit

    // @optional
    // Order in which to perform query
    // @default ASC
    orderBy

    // @optional
    // Filter returned items
    // Any conditions listed here will apply after items have been read from dynamodb and
    // therefore this should be avoided wherever possible, but can be helpful in some cases
    // see this https://www.alexdebrie.com/posts/dynamodb-filter-expressions/ for more details
    where

    // @optional
    // Specify attributes to get, only selected attributes are fetched
    // @default `ALL`
    select
  }
)
```

## BatchManager

Batch manager api. Simplify batch requests using easy to use interface

### BatchManager.write

Writes entities to dynamodb using document client batch manager api with
exponential backoff between retries.

```Typescript
write(
  // Write request input
  writeInput

  // @optional
  // batch write options
  options: {
    // @optional
    // Max number of retries to perform before returning to client
    // @default `BATCH_WRITE_MAX_ALLOWED_ATTEMPTS`
    maxRetryAttempts

    // @optional
    // Max number of requests to run in parallel
    // @default `BATCH_WRITE_CONCURRENCY_LIMIT`
    requestsConcurrencyLimit

    // @optional
    // Exponential backoff multiplication factor to apply on back off algorithm
    // Used to increase wait times between retries
    // @default `1`
    backoffMultiplicationFactor
  }
)
```

### BatchManager.read

Reads entities from dynamodb using document client batch manager api with
exponential backoff between retries.

```Typescript
read(
  // read request input
  readInput

  // batch read options
  options?: {
    // @optional
    // Max number of retries to perform before returning to client
    // @default `BATCH_WRITE_MAX_ALLOWED_ATTEMPTS`
    maxRetryAttempts

    // @optional
    // Max number of requests to run in parallel
    // @default `BATCH_WRITE_CONCURRENCY_LIMIT`
    requestsConcurrencyLimit

    // @optional
    // Exponential backoff multiplication factor to apply on back off algorithm
    // Used to increase wait times between retries
    // @default `1`
    backoffMultiplicationFactor
  }
)

```

## TransactionManager

Transaction manager api.

### TransactionManager.write

Writes entities to dynamodb over document client transaction api.

```Typescript
write(
  // Write request input
  // Must be an instance of `WriteTransaction` class
  transaction
)
```

### TransactionManager.read

Reads entities to from dynamodb over document client transaction api.

```Typescript
read(
  // Read request input
  // Must be an instance of `ReadTransaction` class
  transaction
)
```
